<div>
<h1>A Cappella Browser</h1>
<style>

#type_picker_container, #bpm_picker_container {
  float: left;
  margin-right: 11px;
}

#type_picker, #bpm_picker {
  font-size: 11px;
}

#hide_container {
  float: left;
  margin-left: 8px;
  white-space: nowrap;
}

#browser_head {
  height: 25px;
  padding: 0px;
  margin: 8px;
}

#featured {
  float: right;
  width: 28%;
  border: 1px solid black;
  padding: 8px;
  background-color: #DDD;
}

#featured h3 {
  font-family: Verdana;
  text-align: center;
  letter-spacing: 0.3em;
  margin: 0px 0px 3px 0px;
  font-variant: small-caps;
}

.featured_info {
  border: 1px solid black;
  background-color: #DDF;
  padding: 7px;
  margin-bottom: 5px;
}

.featured_pell {
  border: 1px solid black;
  background-color: white;
  padding: 4px;
  margin-bottom: 5px;
}

.feat_avatar {
  float: left;
  margin: 4px;
}

.feat_title {
  font-weight: bold;
  font-size: 14px;
  color: orange;
}

.feat_user {
  display: block;
  margin: 8px;
}

.clear_me {
  clear: left;
}

.browse_prevnext {
  float: left;
  margin-right: 10px;
}


</style>
<div id="browser_head">
  <div id="type_picker_container">
    Type: <select id="type_picker"></select>
  </div>
  <div id="bpm_picker_container">
    BPM: <select id="bpm_picker"></select>
  </div>
  <div id="hide_container"><input type="checkbox" id="hide_remixed" /> Hide remixed pells</div>
</div>

<div id="featured">
    <tal:block define="feats php:cc_query_fmt('tags=acappella+featured&limit=3&rand=1');" />
    <h3>Featured A Cappellas</h3>
        <div class="featured_info">
        <span style="display:none">wrong spellings: acappela, accapella, acapella</span>
<img src="http://creativecommons.org/images/public/somerights20.gif" style="margin: 8px;float:right"/>
All a cappellas are under a <a href="http://creativecommons.org">Creative Commons</a> license. Please
verify which license applies to each a cappella.
        </div>
    <tal:block repeat="R feats">
        <div class="featured_pell">
            <div class="feat_avatar" >
                <a href="${R/artist_page_url}"><img src="http://ccmixter.org/people/lazztunes07/BlueCover.jpg" />
                <!-- img src="${R/user_avatar_url}"  !--></a>
            </div>
            <a class="feat_title" href="${R/file_page_url}">${R/upload_name}</a>
            <a class="feat_user"  href="${R/artist_page_url}">${R/user_real_name}</a>

            <div class="tdc" style="float:right;width:20px"><a class="cc_playlist_i" id="_plinfo_${R/upload_id}"> </a></div>

            <a href="${R/license_url}" about="" rel="license" title="${R/license_name}" ><img 
                src="${root-url}ccimages/lics/small-${R/license_logo}" /></a>

            <div class="clear_me">&nbsp;</div>
            <table cellspacing="0" cellpadding="0" style="width:100%"><tr><td style="width:30px">Play:</td><td><a class="cc_player_button cc_player_hear" id="_ep_${R/upload_id}" href="${R/fplay_url}"> </a></td></tr></table>
        </div>
    </tal:block>
</div>

<div id="browser">
  getting data...
</div>
<div>
  <a id="browser_prev" class="browse_prevnext" href="javascript://browser_prev"><span tal:content="php:_('Prev')" /></a> 
  <a id="browser_next" class="browse_prevnext" href="javascript://browser_next"><span tal:content="php:_('Next')" /></a>
  <div id="query" style="font-wieght:bold"></div>
</div>
<link rel="stylesheet" type="text/css" href="${root-url}cctemplates/playlist.css" title="Default Style" />
<link rel="stylesheet" type="text/css" href="${root-url}cctemplates/detail.css"   title="Default Style" />
<script src="${root-url}cctemplates/js/playlist.js" ></script>
<metal:block use-macro="playerembed.xml/eplayer" />
<script>
//<!--
var feat_playlistMenu = new ccPlaylistMenu( { autoHook: false } );
feat_playlistMenu.hookElements($('featured_pell'));

ccPellBrowser = Class.create();

ccPellBrowser.prototype = {

    allTypes: [ [ 'acappella+melody', 'Melody' ], 
                [ 'acappella+rap', 'Rap' ],
                [ 'acappella+spoken_word', 'Spoken Word' ],
                [ 'acappella+featured', 'Featured' ],
                [ 'acappella', 'All ' ] ],
    currOffset: 0,
    currType: 'acappella+melody',
    totalCount: 0,
    perPage: 30,
    hideRemixed: 0,
    query: '',
    currBPM: '-',

    initialize: function(options) {
        this.options = Object.extend( { autoHook: true }, options || {} );
        this.hookElements();
    },

    hookElements: function() {
      Event.observe( $('browser_prev'), 'click', this.onPrevClick.bindAsEventListener( this ) );
      Event.observe( $('browser_next'), 'click', this.onNextClick.bindAsEventListener( this ) );
      Event.observe( $('hide_remixed'), 'click', this.onHideRemixedClick.bindAsEventListener( this ) );

      var type_picker = $('type_picker');
      var i = 0;
      this.allTypes.each( function(t) {
        type_picker.options[i++] = new Option( t[1], t[0] );
      } );
      Event.observe( type_picker, 'change', this.onTypeClick.bindAsEventListener( this ) );

      i = 0;
      var b1, b2, p1, p2;
      var bpm_picker = $('bpm_picker');
      bpm_picker.options[i++] = new Option( 'All', '-' );
      bpm_picker.options[i++] = new Option( 'Below 60', 'bpm_below_60' );
      for( b1 = 60; b1 < 180; b1 += 5 )
      {
        b2 = b1 + 5;
        p1 = b1 < 100 ? '0' + b1 : b1;
        p2 = b2 < 100 ? '0' + b2 : b2;
        bpm_picker.options[i++] = new Option( ' ' + b1 + '-' + (b1+4), 'bpm_' + p1 + '_' + p2);
      }
      bpm_picker.options[i++] = new Option( 'Above 180', 'bpm_above_180' );
      Event.observe( bpm_picker, 'change', this.onBPMClick.bindAsEventListener( this ) );

      this.refreshCount();
    },

    onBPMClick: function() {
        var bpm_picker = $('bpm_picker');
        this.currBPM = bpm_picker.options[bpm_picker.selectedIndex].value;
        this.refreshCount();
    },

    onHideRemixedClick: function() {
      this.hideRemixed ^= 1;
      this.refreshCount();
    },

    changeType: function() {
        var type_picker = $('type_picker');
        var type = type_picker.options[type_picker.selectedIndex].value;
        this.currType = type;
        this.refreshCount();
    },

    getQuery: function() {
        this.query = 'tags=' + this.currType;
        if( this.currBPM != '-' )
            this.query += '+' + this.currBPM;
        if( this.hideRemixed )
            this.query += '&remixmax=0';
    },

    refreshCount: function() {
        $('browser').innerHTML = '...';
        this.currOffset = 0;
        this.getQuery();
        var url = home_url + 'api/query' + q + this.query + '&f=count';
        this.transport = new Ajax.Request( url, { method: 'get', onComplete: this.fillCount.bind(this) } );
    },

    fillCount: function( resp ) {
        $('browser_prev').style.display = 'none';
        $('browser_next').style.display = 'none';        
        this.totalCount = eval(resp.responseText)[0];
        if( this.totalCount > 0 )
        {
          this.refreshContent();
        }
        else
        {
          $('browser').innerHTML = 'no records match';
        }
    },

    refreshContent: function() {
        var url = home_url + 'api/query' + q + this.query + '&f=html&t=embedded_playlist&limit=25&offset=' + this.currOffset;
        this.transport = new Ajax.Request( url, { method: 'get', onComplete: this.fillContent.bind(this) } );
    },

    fillContent: function( resp ) {
      try
      {
        var browser = $('browser');
        browser.innerHTML = resp.responseText;
        ccEPlayer.hookElements(browser);
        if( !this.playlistMenu )
            this.playlistMenu = new ccPlaylistMenu( { autoHook: false, playlist: this } );

        // hook the menus, info button, et. al.
        this.playlistMenu.hookElements(browser);

        var prev_mode = this.currOffset > 0 ? 'block' : 'none';
        var next_mode = (this.totalCount - this.perPage) > this.currOffset ? 'block' : 'none';
        $('browser_prev').style.display = prev_mode;
        $('browser_next').style.display = next_mode;
      }
      catch (err)
      {
        alert(err);
      }
    },

    onPrevClick: function() {
      if( currOffset > 0 )
      {
          this.currOffset -= this.perPage;
          this.refreshContent();
      }
    },

    onNextClick: function() {
      this.currOffset += this.perPage;
      this.refreshContent();
    },

    onTypeClick: function( e ) {
      this.changeType();
    }
}

new ccPellBrowser();
//-->
</script>

</div>