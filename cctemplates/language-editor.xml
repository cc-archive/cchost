<tal:block>
<tal:block replace="">
<!--

Creative Commons has made the contents of this file
available under a CC-GNU-GPL license:

 http://creativecommons.org/licenses/GPL/2.0/

 A copy of the full license can be found as part of this
 distribution in the file LICENSE.TXT

You may use the ccHost software in accordance with the
terms of that license. You agree that you are solely 
responsible for your use of the ccHost software and you
represent and warrant to Creative Commons that your use
of the ccHost software will comply with the CC-GNU-GPL.

$Id$

-->
</tal:block>

<metal:block define-macro="language_editor_menu">
<style>
.h {
  font-weight: bold;
  text-align: right;
}
#msg {
  height: 25px;
  text-align: center;
  margin: 4px;
  font-weight: bold;
  padding: 4px;
  color: orange;
}

#explain {
  margin: 5px;
  padding: 8px;
  /*
  background-color: #DDF;
  border: 1px solid black;
  */
}
#explain div {
  margin: 0px 0px 12px 0px;
  padding: 6px;
}
</style>
<script>
//<!--
function create_new_domain()
{
    var domname = $$F('newdomainname');
    if( !domname )
    {
        alert('${LEM/str_nodomname}');
        return false;
    }

    var url = home_url + 'admin/terms/makedomain/' + domname + '#menu';
    document.location = url;
}

function create_new_language()
{
    var newlanguage = $$F('newlangname');
    if( !newlanguage )
    {
        alert('${LEM/str_missinglangname}');
        return false;
    }
    var domain = $$F('domains');
    var url = home_url + 'admin/terms/makelanguage/' + domain + '/' + newlanguage + '#menu';
    document.location = url;    
}

function edit_existing_language()
{
    var path = $$F('domlangs');
    path = path.substr('locale'.length);
    var url = home_url + 'admin/termseditor' + path;
    document.location = url;
}

//-->
</script>
  <div class="cc_form_about" id="explain">
    <div tal:repeat="ex LEM/str_explain">${ex}</div>
  </div>
  <a name="menu"></a>
   <table>
      <tr>
        <td colspan="3" >
          <div id="msg"><span>${LEM/msg}</span></div>
        </td>
      </tr>
      <tr>
        <td  class="h" colspan="2">
            ${LEM/str_createnewdomain}
        </td>
        <td>
            <input type="text" id="newdomainname" name="newdomainname" />
        </td>
        <td> 
            <a class="cc_gen_button" id="createdomaingo" href="javascript://new domain"
              onclick="create_new_domain()"><span>${LEM/str_go}</span></a>
        </td>
             
      </tr>
      <tr>
          <td class="h">
              ${LEM/str_createnewlang}
          </td>
          <td>
              <select id="domains" name="domains">
                  <tal:block repeat="D LEM/locales">
                      <option value="${repeat/D/key}" tal:attributes="selected D/selected">${repeat/D/key}</option>
                  </tal:block>
              </select>
          </td>
        <td>
            <tal:block condition="LEM/syslocales">
              <select id="newlangname">
                  <option tal:repeat="newlang LEM/syslocales" value="${newlang}">${newlang}</option>
              </select>
            </tal:block>
            <tal:block condition="not: LEM/syslocales">
              <input type="text" id="newlangname" name="newlangname" />
            </tal:block>
        </td>
        <td> 
            <a class="cc_gen_button" href="javascript://new language"
                    onclick="create_new_language()"><span>${LEM/str_go}</span></a>
        </td>
      </tr>
      <tr>
          <td class="h" colspan="2">
             ${LEM/str_editanexisting}
          </td>
          <td>
          <select id="domlangs" name="domlangs">
               <tal:block repeat="doms LEM/locales">
                  <tal:block define="thisdom repeat/doms/key" />
                  <tal:block repeat="langs doms/language">
                      <option value="${langs/path}"
                          tal:attributes="selected langs/selected;"
                          >${thisdom} / ${repeat/langs/key}</option>
                  </tal:block>
               </tal:block>
          </select>
          </td>
        <td> 
            <a id="commentcommand" href="javascript://edit language"
                    onclick="edit_existing_language()"><span>${LEM/str_go}</span></a>
        </td>
      </tr>
   </table>
   <div style="height:200px;">&nbsp;</div>
</metal:block>

<metal:block define-macro="language_editor">

<style>
#editor_table legend {
  font-weight: bold;
  padding: 2px;
}

#string_list {
  margin-right: 12px;
}

#what_part,#string_table {
  font-size:10px; 
}
#what_part {
  margin-righ: 60%;
}
#string_table {
  width: 225px;
  height: 290px;
  margin-top: 14px;
}
#editor_table td {
  vertical-align: top;
}
#msgid {
  background-color: #DDF;
  padding: 1px;
}
#msgid pre {
  border: 1px solid black;
  background-color: #EEE;
  padding: 2px;
  margin: 0px;
}
#msgstr {
  width: 100%;
}
#msgid pre, #msgstr { /* these should be the same */
  font-size: 11px;
  font-family: Arial, sans serif
}

#copystr {
  float:right;
  text-align: right;
  display: block;
}
#edstatus {
  padding: 2px;
  margin: 6px;
  font-style: italic;
  font-size: 10px;
  color: #464;
  background-color: #EFE;
  border: 1px solid #9B9;
}
#search {
 margin-top: 14px;
 width: 100%;
}
#search input {
  font-size: 10px;
  font-family: Verdana;
  width: 120px;
  }

</style>
<script>
//<!--
var myGlobalHandlers = {
    onCreate: function(){
        ed_status('${LE/str_waiting}');
    },

    onComplete: function(req,t,json) {
        if(Ajax.activeRequestCount == 0) {
            if( json && json.statmsg )
                ed_status(json.statmsg);
            else
                ed_status('');
        }
        else {
            ed_status('..',true);
        }
    }
};

Ajax.Responders.register(myGlobalHandlers);

function ed_status(msg,append)
{
    if( !msg || msg.length == 0 )
    {
        Element.hide('edstatus');
    }
    else
    {
        Element.show('edstatus');
        if( append )
            $$('edstatus').innerHTML += msg;
        else
            $$('edstatus').innerHTML = msg;
    }
}

currentDomain = '${LE/domain}';
currentLanguage = '${LE/language}';
currentHash = '';

function get_domain()
{
    if( !currentDomain )
    {
        alert('${LE/str_missing_domain}');
        return false;
    }
    return true;
}

function get_language()
{
    if( !currentLanguage )
    {
        alert('${LE/str_missing_language}');
        return false;
    }
    return true;
}

function commit_pot()
{
    if( !get_domain() )
        return;
    if( !get_language() )
        return;
  
    var url = home_url + 'admin/terms/writepot/' + currentDomain + '/' 
                + currentLanguage + '/' +
                q + 't=' + (new Date()).getTime();

    debug_url(url);

    new Ajax.Request( url, {method:'get'});
}

function save_to()
{
    if( !get_domain() )
        return;
    if( !get_language() )
        return;
    
    var url = home_url + "admin/terms/saveto/" + currentDomain + 
            '/' + currentLanguage;

    document.location = url;
}

function commit_string()
{
    if( !get_domain() )
        return;
    if( !get_language() )
        return;
    
    var msgstr = escape($$F('msgstr'));

    var url = home_url + "admin/terms/edit/" + currentDomain + 
            '/' + currentLanguage +
            '/' + currentHash + q + "string=" + msgstr + 
            '&t=' + (new Date()).getTime();

    clear_string();

    debug_url(url);

    new Ajax.Request( url, {method:'get'});
}

function clear_string()
{
    var e = $$('string_table');
    var opts = e.options;
    var str = opts[e.selectedIndex].text;
    if( str.charAt(0) == '*' )
        opts[e.selectedIndex].text = str.substring(1);    
}

function revert_to()
{
    $$('msgstr').value = '';
    commit_string();
}

function get_string()
{
    if( !get_domain() )
        return;
    if( !get_language() )
        return;

    var hash = currentHash = $$F('string_table');
    var url = home_url + 'admin/terms/getstring/' + currentDomain + '/'
                + currentLanguage + '/' + hash;
    debug_url(url);

    Element.hide('editor');
    var t = (new Date()).getTime();
    var myAjax = new Ajax.Request( 
        url + q + t, 
        { 
            method: 'get', 
            onComplete: got_string
        }
    );    
}

function got_string(req,d)
{
    // IE will not honor existing pre tags, but loves
    // it when you add them here:
    $$('msgid').innerHTML = '<pre>' + d.msgid.escapeHTML() + '</pre>';
    $$('msgstr').value = d.msgstr;
    $$('target_file').innerHTML = d.target_file;
    $$('context').innerHTML = '<pre>#:' + d.context + '</pre>';
    Element.show('editor');
}

function copy_string()
{
    $$('msgstr').value += $$('msgid').innerHTML.unescapeHTML();
    $$('msgstr').activate();
}

function commit_and_next()
{
    commit_string();
    try
    {
      $$('string_table').selectedIndex++;
      get_string();
    	
    } catch (e) {}
}

function change_part(box)
{
    if( !get_domain() )
        return false;
    if( !get_language() )
        return;

    var part = $$F(box);
    var url = home_url + 'admin/termseditor/' + currentDomain + '/' +
              currentLanguage + '/' + part;
    document.location = url;
}

function clear_search()
{
    var url = home_url + 'admin/termseditor/' + currentDomain + '/' +
              currentLanguage;
    document.location = url;
}

function do_search()
{
    if( !get_domain() )
        return false;

    var query = $$F('q');
    if( !query )
    {
      alert( '${LE/str_empty_search}' );
      return false;
    }
    var url = home_url + 'admin/termseditor/' + currentDomain + '/'
             + currentLanguage + q + 'q=' + escape(query);

    document.location = url;
}


function debug_url(url)
{
    return;
    $$('strlink').href = url;
    $$('strlink').innerHTML = url;
}
//-->
</script>
<table id="editor_table">
  <tr>
    <td>
      <fieldset id="string_list">
        <legend>${LE/str_select_a_string}</legend>
        <select id="what_part" onchange="change_part(this);">
            <option value="0">${LE/str_part1}</option>
            <option value="1">${LE/str_part2}</option>
            <option value="2">${LE/str_part3}</option>
            <option value="3">${LE/str_part4}</option>
            <option value="3">${LE/str_part5}</option>
        </select><br />
        <select id="string_table" name="string_table" size="20" onchange="get_string();">
          <tal:block repeat="lstr LE/string_table">
            <option value="${repeat/lstr/key}" tal:content="php: CC_strchop('$lstr/0',40)" />
          </tal:block>
        </select><div id="search">
              <a id="commentcommand"  href="javascript://search" 
                    onclick="do_search(); return false;"><span tal:content="LE/str_search" /></a>&nbsp;
                 <input id="q" name="q" type="text" value="${LE/str_query}" /></div>
              <div tal:condition="LE/str_query"><br /><a id="commentcommand" 
                    href="javascript://clear search"
                   onclick="clear_search(); return false;"><span tal:content="LE/str_clear" /></a></div>
           
      </fieldset>
      <div id="edstatus" style="display:none">&nbsp;</div>
    </td>
    <td>
      <fieldset>
        <legend>${LE/str_domain}</legend>
        <table>
          <tr>
            <td>
              ${LE/str_currently_ed} ${LE/domain}/${LE/language}
            </td>
            <td>
              <a id="commentcommand" href="javascript://write pot" 
                    onclick="commit_pot(); return false;">
                <span>${LE/str_generate_pot}</span>
              </a>
            </td>
          </tr>
          <!-- tr>
            <td />
            <td>
              <a id="commentcommand" href="javascript://write pot" 
                    onclick="save_to(); return false;">
                <span>${LE/str_save_to}</span>
              </a>
            </td>
          </tr -->
        </table>
      </fieldset>
      <div id="editor" style="display:none">
        <fieldset>
          <legend>${LE/str_original_string</legend>
          <div id="context">&nbsp;</div>
          <div id="msgid">
          </div><br />
          <a id="copystr" class="cc_gen_button" 
                  href="javascript://copy it" onclick="copy_string(); return false;">
            <span>${LE/str_copy_this_string}</span>
          </a>
        </fieldset>
        <fieldset>
          <legend>${LE/str_translates_to}</legend>
          <textarea id="msgstr" name="msgstr" rows="6" cols = "45">
            
          </textarea>
          <table>
            <tr>
              <td>
                <a class="cc_gen_button" id="commitbutton" style="float:left" 
                    href="javascript://commit and go to next string" 
                    onclick="commit_and_next(); return false;" >
                  <span>${LE/str_commit_and_advance}</span>
                </a>
              </td>
              <td>
                <a class="cc_gen_button" id="commitbutton" style="float:left" 
                    href="javascript://commit it" onclick="commit_string(); return false;" >
                  <span>${LE/str_commit}</span>
                </a>
              </td>
              <td>
                <a id="commentcommand" href="javascript://revert it" 
                    onclick='revert_to(currentHash); return false;'>
                  <span>${LE/str_revert}</span>
                </a>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <span id="lang_to">${LE/str_will_be_saved_to}</span>: <span id="target_file"></span>
              </td>
            </tr>
          </table>
        </fieldset>
      </div>
    </td>
  </tr>
</table>
<div><a id="strlink" href=""></a></div>
<script>
$$('what_part').selectedIndex = ${LE/what_part};
</script>
</metal:block>
</tal:block>
