<tal:block>
<tal:block replace="">
<!--

Creative Commons has made the contents of this file
available under a CC-GNU-GPL license:

 http://creativecommons.org/licenses/GPL/2.0/

 A copy of the full license can be found as part of this
 distribution in the file LICENSE.TXT

You may use the ccHost software in accordance with the
terms of that license. You agree that you are solely 
responsible for your use of the ccHost software and you
represent and warrant to Creative Commons that your use
of the ccHost software will comply with the CC-GNU-GPL.

$Id$

-->
</tal:block>
<metal:block define-macro="language_editor">

<style>
#editor_table legend {
  font-weight: bold;
  padding: 2px;
}

#string_list {
  margin-right: 12px;
}

#what_part,#string_table {
  font-size:10px; 
}
#what_part {
  margin-righ: 60%;
}
#string_table {
  width: 225px;
  height: 340px;
  margin-top: 14px;
}
#editor_table td {
  vertical-align: top;
}
#msgid {
  background-color: #DDF;
  padding: 1px;
}
#msgid pre {
  border: 1px solid black;
  background-color: #EEE;
  padding: 2px;
  margin: 0px;
}
#msgstr {
  width: 100%;
}
#msgid pre, #msgstr { /* these should be the same */
  font-size: 11px;
  font-family: Arial, sans serif
}

#copystr {
  float:right;
  text-align: right;
  display: block;
}
#edstatus {
  padding: 2px;
  margin: 6px;
  font-style: italic;
  font-size: 10px;
  color: #464;
  background-color: #EFE;
  border: 1px solid #9B9;
}
#search {
 margin-top: 14px;
 width: 100%;
}
#search input {
  font-size: 10px;
  font-family: Verdana;
  width: 120px;
  }

</style>
<script>
//<!--
var myGlobalHandlers = {
    onCreate: function(){
        ed_status('${LE/str_waiting}');
    },

    onComplete: function(req,t,json) {
        if(Ajax.activeRequestCount == 0) {
            if( json && json.statmsg )
                ed_status(json.statmsg);
            else
                ed_status('');
        }
        else {
            ed_status('..',true);
        }
    }
};

Ajax.Responders.register(myGlobalHandlers);

function ed_status(msg,append)
{
    if( !msg || msg.length == 0 )
    {
        Element.hide('edstatus');
    }
    else
    {
        Element.show('edstatus');
        if( append )
            $$('edstatus').innerHTML += msg;
        else
            $$('edstatus').innerHTML = msg;
    }
}

currentDomain = '';
currentHash = '';

function get_domain()
{
    currentDomain = $$F('domain'); 
    if( !currentDomain )
    {
        alert('${LE/str_missing_domain}');
        return false;
    }
    return true;
}

function commit_pot()
{
    if( !get_domain() )
        return;
  
    var url = home_url + 'admin/terms/writepot/' + currentDomain + 
                q + 't=' + (new Date()).getTime();

    debug_url(url);

    new Ajax.Request( url, {method:'get'});
}

function commit_string()
{
    if( !get_domain() )
        return;
    
    var msgstr = escape($$F('msgstr'));

    var url = home_url + "admin/terms/edit/" + currentDomain + 
            "/" + currentHash + q + "string=" + msgstr + 
            '&t=' + (new Date()).getTime();

    clear_string();

    debug_url(url);

    new Ajax.Request( url, {method:'get'});
}

function clear_string()
{
    var e = $$('string_table');
    var opts = e.options;
    var str = opts[e.selectedIndex].text;
    if( str.charAt(0) == '*' )
        opts[e.selectedIndex].text = str.substring(1);    
}

function revert_to()
{
    $$('msgstr').value = '';
    commit_string();
}

function get_string()
{
    if( !get_domain() )
        return;

    var hash = currentHash = $$F('string_table');
    var url = home_url + 'admin/terms/getstring/' + currentDomain + "/" + hash;
    debug_url(url);

    Element.hide('editor');
    var t = (new Date()).getTime();
    var myAjax = new Ajax.Request( 
        url + q + t, 
        { 
            method: 'get', 
            onComplete: got_string
        }
    );    
}

function got_string(req,d)
{
    // IE will not honor existing pre tags, but loves
    // it when you add them here:
    $$('msgid').innerHTML = '<pre>' + d.msgid.escapeHTML() + '</pre>';
    $$('msgstr').value = d.msgstr;
    $$('target_file').innerHTML = d.target_file;
    $$('context').innerHTML = '<pre>#:' + d.context + '</pre>';
    Element.show('editor');
}

function copy_string()
{
    $$('msgstr').value += $$('msgid').innerHTML.unescapeHTML();
    $$('msgstr').activate();
}

function commit_and_next()
{
    commit_string();
    try
    {
      $$('string_table').selectedIndex++;
      get_string();
    	
    } catch (e) {}
}

function change_part(box)
{
    if( !get_domain() )
        return false;

    var part = $$F(box);
    var url = home_url + 'admin/terms/' + currentDomain + '/' + part;
    document.location = url;
}

function do_search()
{
    if( !get_domain() )
        return false;

    var query = $$F('q');
    if( !query )
    {
      alert( '${LE/str_empty_search}' );
      return false;
    }
    var url = home_url + 'admin/terms/' + currentDomain + q + 'q=' + query;
    document.location = url;
}

function debug_url(url)
{
    return;
    $$('strlink').href = url;
    $$('strlink').innerHTML = url;
}
//-->
</script>
<table id="editor_table">
  <tr>
    <td>
      <fieldset id="string_list">
        <legend>${LE/str_select_a_string}</legend>
        <select id="what_part" onchange="change_part(this);">
            <option value="0">${LE/str_part1}</option>
            <option value="1">${LE/str_part2}</option>
            <option value="2">${LE/str_part3}</option>
            <option value="3">${LE/str_part4}</option>
            <option value="3">${LE/str_part5}</option>
        </select><br />
        <select id="string_table" name="string_table" size="20" onchange="get_string();">
          <tal:block repeat="lstr LE/string_table">
            <option value="${repeat/lstr/key}" tal:content="php: CC_strchop('$lstr/0',40)" />
          </tal:block>
        </select><div id="search">
              <a id="commentcommand"  href="javascript://search" 
                    onclick="do_search(); return false;"><span tal:content="LE/str_search" /></a>&nbsp;
                 <input id="q" name="q" type="text" value="${LE/str_query}" /></div>
      </fieldset>
      <div id="edstatus" style="display:none">&nbsp;</div>
    </td>
    <td>
      <fieldset>
        <legend>${LE/str_domain}</legend>
        <table>
          <tr>
            <td>
              <input id="domain" name="domain" value="${LE/domain}" />
            </td>
            <td>
              <a id="commentcommand" href="javascript://write pot" 
                    onclick="commit_pot(); return false;">
                <span>${LE/str_generate_pot}</span>
              </a>
            </td>
          </tr>
        </table>
      </fieldset>
      <div id="editor" style="display:none">
        <fieldset>
          <legend>${LE/str_original_string</legend>
          <div id="context">&nbsp;</div>
          <div id="msgid">
          </div><br />
          <a id="copystr" class="cc_gen_button" 
                  href="javascript://copy it" onclick="copy_string(); return false;">
            <span>${LE/str_copy_this_string}</span>
          </a>
        </fieldset>
        <fieldset>
          <legend>${LE/str_translates_to}</legend>
          <textarea id="msgstr" name="msgstr" rows="11" cols = "45">
            
          </textarea>
          <table>
            <tr>
              <td>
                <a class="cc_gen_button" id="commitbutton" style="float:left" 
                    href="javascript://commit and go to next string" 
                    onclick="commit_and_next(); return false;" >
                  <span>${LE/str_commit_and_advance}</span>
                </a>
              </td>
              <td>
                <a class="cc_gen_button" id="commitbutton" style="float:left" 
                    href="javascript://commit it" onclick="commit_string(); return false;" >
                  <span>${LE/str_commit}</span>
                </a>
              </td>
              <td>
                <a id="commentcommand" href="javascript://revert it" 
                    onclick='revert_to(currentHash); return false;'>
                  <span>${LE/str_revert}</span>
                </a>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <span id="lang_to">${LE/str_will_be_saved_to}</span>: <span id="target_file"></span>
              </td>
            </tr>
          </table>
        </fieldset>
      </div>
    </td>
  </tr>
</table>
<div><a id="strlink" href=""></a></div>
<script>
$$('what_part').selectedIndex = ${LE/what_part};
</script>
</metal:block>
</tal:block>
