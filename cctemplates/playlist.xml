<tal:block>
<metal:block define-macro="playlist_create_dyn">
  <link rel="stylesheet" type="text/css" href="${root-url}cctemplates/playlist.css" title="Default Style" />
  <div id="dyn_filter_editor">
    <div id="filter_form">
    </div>
  </div>
  <div id="debug"></div>
  <script src="${root-url}cctemplates/js/query_filter.js" ></script>
  <script src="${root-url}cctemplates/js/autocomp.js" ></script>
  <script src="${root-url}cctemplates/js/autopick.js" ></script>
  <script>
    var params = ${plargs/edit_query};
    var filters = new ccQueryBrowserFilters( params );
    var formatter = new ccFormatter();
    var formInfo = filters.makeForm( 'ff', formatter );
    $('filter_form').innerHTML = formInfo.html;
    formatter.setup_watches();
    $(formInfo.innerId).style.display = 'block';
    Event.observe(formInfo.submitId,'click',onFilterSubmit.bindAsEventListener());
    $(formInfo.submitId).innerHTML = '<span>${plargs/submit_text}</span>';
    function onFilterSubmit(event) {
      var qstring = filters.queryString() + '&f=playlist';
      var promo_tag = '${plargs/promo_tag}';
      if( promo_tag.length > 0 )
        qstring += '&promo_tag=' + promo_tag;
      document.location.href = '${plargs/submit_url}' + q + qstring;
    }
  </script>
</metal:block>

<metal:block define-macro="playlist_popup">
  <tal:block repeat="R args/with">
      <a href="${home-url}api/playlist/remove/${args/upload_id}/${R/cart_id}" 
          class="cc_playlist_menu_item"><span>Remove from <span class="cc_playlist_name">${R/cart_name}</span></span></a>
  </tal:block>
  <tal:block repeat="R args/without">
      <a href="${home-url}api/playlist/add/${args/upload_id}/${R/cart_id}" 
            class="cc_playlist_menu_item"><span>Add to <span class="cc_playlist_name">${R/cart_name}</span></span></a>
  </tal:block>
  <a href="${home-url}api/playlist/new/${args/upload_id}" 
      class="cc_playlist_menu_item cc_playlist_add_mi"><span>Add to new playlist</span></a>
</metal:block>

<metal:block define-macro="playlist_browse">
<tal:block repeat="PL records">
  <div class="cc_playlist_line" id="_pl_${PL/cart_id}">${PL/cart_name} <span class="cc_playlist_dyn_user">created by
      ${PL/user_real_name}</span>
    <span class="cc_playlist_dyn_label" tal:condition="PL/cart_dynamic" tal:content="php:_('(dynamic)')" />
    <span tal:content="php: CC_strchop(str_replace(',',' ',${PL/cart_tags}),110)" />
    <span tal:condition="not: PL/cart_dynamic" > items: ${PL/cart_num_items}</span>
  </div>
</tal:block>
<metal:block use-macro="${prev_next_links}" />
</metal:block>

<metal:block define-macro="playlist_list">
    <table class="cc_pl_table"><tr><td>
      <tal:block condition="args/menu">
        <ul class="cc_playlist_owner_menu">
          <li tal:repeat="MI args/menu">
            <a target="_parent" href="${MI/url}" id="${MI/id}" class="${MI/class}" ><span tal:content="MI/text" /></a>
          </li>
        </ul>      
      </tal:block>
    </td><td>
      <tal:block condition="args/feed_q">
        <div class="cc_playlist_feed"><a target="_parent" href="${args/feed_q}">
          <img src="${root-url}ccimages/feed-icon16x16.png" /></a></div>
      </tal:block>
      <tal:block define="R args/playlist" />
      <a target="_parent" href="${home-url}playlist/browse/${R/cart_id}"><div class="cc_playlist_title" >${R/cart_name}</div> </a>
      <span class="cc_playlist_date">
        Created by <a target="_parent" href="${R/artist_page_url}">${R/user_real_name}</a> on ${R/cart_date_format}
      </span>
      <div tal:condition="R/cart_desc" class="gd_description" id="pldesc_${R/cart_id}">
        <div style="padding: 10px;">
          <tal:block define="cdesc php:cc_format_text('${R/cart_desc}');" />
          ${cdesc}
        </div>
      </div>
    </td></tr></table>
  <div class="cc_pl_div" id="_cart_${R/cart_id}">
    <tal:block define="reguser args/is_logged_in" />
    <tal:block define="records args/records" />
    <metal:block use-macro="playlist.xml/playlist_list_lines" />
  </div>
  <span id="pl_user_${R/cart_id}" tal:condition="args/is_logged_in" />
  <span id="pl_owner_${R/cart_id}" tal:condition="args/is_owner" />
  <br clear="right" /><!-- *cough* -->
</metal:block>

<metal:block define-macro="playlist_list_lines">
  <div class="trr" tal:repeat="item records">
    <div class="tdc cc_playlist_item"   id="_pli_${item/upload_id}" >
      <tal:block define="iun php:CC_strchop(${item/upload_name},30,true);" />
      <span> <a class="cc_playlist_pagelink" id="_plk_${item/upload_id}" target="_parent" 
          href="${item/file_page_url}">${iun}</a> </span> by 
      <tal:block define="iurn php:CC_strchop(${item/user_real_name},30,true);" />
      <a target="_parent" href="${item/artist_page_url}">${iurn}</a> 
    </div>
    <div class="tdc"><a class="cc_playlist_i" id="_plinfo_${item/upload_id}"> </a></div>
    <div tal:condition="reguser" id="playlist_menu_${item/upload_id}" class="cc_playlist_action tdc">
            <a  class="cc_playlist_button" 
                href="javascript://playlist_menu_${item/upload_id}"><span>Add To...</span></a>
    </div>
    <div tal:condition="item/fplay_url" class="tdc cc_playlist_pcontainer" >
      <a  class="cc_player_button cc_player_hear" 
        id="_ep_${R/cart_id}_${item/upload_id}" href="${item/fplay_url}"> </a>
    </div>
    <div class="hrc"> </div>
  </div>
</metal:block>

<metal:block define-macro="playlist_list_window_cart">
  <div class="cc_playlist_popup_window">
  <table class="cc_pl_table" cellpadding="0" cellspacing="0"><tr><td>
    <tal:block condition="args/menu">
      <ul class="cc_playlist_owner_menu">
        <li tal:repeat="MI args/menu">
          <a target="_parent" href="${MI/url}" id="${MI/id}" class="${MI/class}" ><span tal:content="MI/text" /></a>
        </li>
      </ul>      
    </tal:block>
  </td><td>
    <tal:block define="R args/playlist" />
    <a target="_parent" href="${home-url}playlist/browse/${R/cart_id}">
      <div class="cc_playlist_title" >${R/cart_name}</div> 
    </a>
    <span class="cc_playlist_date">
      Created by <a target="_parent" href="${R/artist_page_url}">${R/user_real_name}</a> 
      <br />${R/cart_date_format}
    </span>
  </td></tr>
  <tr><td /><td style="height:22px;">
    <div class="cc_playlist_pcontainer" id="plc_id" ></div>
  </td></tr>
  </table>
  <table class="cc_pl_table" >
  <tr tal:repeat="item args/records">
    <td class="cc_playlist_item"   id="_pli_${item/upload_id}" >
      <tal:block define="iname php:CC_strchop(${item/upload_name},45)" />
      <tal:block define="uname php:CC_strchop(${item/user_real_name},22)" />
      <span> <a target="_parent" href="${item/file_page_url}">${iname}</a> </span> by 
      <a target="_parent" href="${item/artist_page_url}">${uname}</a> 
    </td>
    <td tal:condition="item/fplay_url" class="cc_playlist_pcontainer" >
      <a  class="cc_player_button cc_player_hear"
        id="_ep_${R/cart_id}_${item/upload_id}" href="${item/fplay_url}"> </a>
    </td>
  </tr>
  </table>
  <span id="pl_user_${R/cart_id}" tal:condition="args/is_logged_in" />
  <span id="pl_owner_${R/cart_id}" tal:condition="args/is_owner" />
  </div>
</metal:block>

<metal:block define-macro="playlist_popup_window">
  <link rel="stylesheet" type="text/css" href="${root-url}cctemplates/playlist.css" title="Default Style" />
  <tal:block define="player_options string:autoHook: false,showVolume: false,showProgress: false,plcc_id: 'plc_id'" />
  <script src="${root-url}cctemplates/js/playlist.js" ></script>
  <metal:block use-macro="playlist.xml/playlist_list_window_cart" />
  <metal:block use-macro="playerembed.xml/eplayer" />
  <script>
    new ccPlaylistMenu();
    new ccPagePlayer(${args/playlist/cart_id});
    new ccParentRedirector(); 
  </script>
  <style>
  div.cc_playlist_popup_window,
  #cc_wrapper1, #cc_wrapper2
  #cc_content, #cc_centercontent {
     width: auto;
  }
  #plc_id {
    width: 250px;
  }
  body {
    margin: 5px;
  }
  h1 { display: none; } /* don't ask */
  </style>
</metal:block>

<metal:block define-macro="playlist_show_one">
  <link rel="stylesheet" type="text/css" href="${root-url}cctemplates/playlist.css" title="Default Style" />
  <link rel="stylesheet" type="text/css" href="${root-url}cctemplates/detail.css"   title="Default Style" />
  <tal:block define="player_options string:autoHook: false" />
  <script src="${root-url}cctemplates/js/playlist.js" ></script>
  <metal:block use-macro="playlist.xml/playlist_list" />
  <metal:block use-macro="playerembed.xml/eplayer" />
  <script>
    new ccPlaylistMenu();
    new ccPagePlayer(${args/playlist/cart_id});
  </script>
</metal:block>

<metal:block define-macro="playlist_show_browser">
  <link rel="stylesheet" type="text/css" href="${root-url}cctemplates/playlist.css" title="Default Style" />
  <link rel="stylesheet" type="text/css" href="${root-url}cctemplates/detail.css"   title="Default Style" />
  <script src="${root-url}cctemplates/js/playlist.js" ></script>
  <div id="playlist_browser" class="grid"><span>getting playlists...</span></div>
  <tal:block define="player_options string:autoHook: false" />
  <metal:block use-macro="playerembed.xml/eplayer" />
  <script>
    var plb = new ccPlaylistBrowser( 'playlist_browser', ${args} );
  </script>
</metal:block>

<metal:block define-macro="playlist_menu">
  <link rel="stylesheet" type="text/css" href="${root-url}cctemplates/playlist.css" title="Default Style" />
  <script src="${root-url}cctemplates/js/playlist.js" ></script>
  <script>
    new ccPlaylistMenu();
  </script>
</metal:block>

<metal:block define-macro="playlist_edit_order">
<script language="JavaScript" type="text/javascript" src="${site-root}cctemplates/js/tool-man/source/org/tool-man/core.js"></script>
<script language="JavaScript" type="text/javascript" src="${site-root}cctemplates/js/tool-man/source/org/tool-man/events.js"></script>
<script language="JavaScript" type="text/javascript" src="${site-root}cctemplates/js/tool-man/source/org/tool-man/css.js"></script>
<script language="JavaScript" type="text/javascript" src="${site-root}cctemplates/js/tool-man/source/org/tool-man/coordinates.js"></script>
<script language="JavaScript" type="text/javascript" src="${site-root}cctemplates/js/tool-man/source/org/tool-man/drag.js"></script>
<script language="JavaScript" type="text/javascript" src="${site-root}cctemplates/js/tool-man/source/org/tool-man/dragsort.js"></script>
<script language="JavaScript" type="text/javascript" src="${site-root}cctemplates/js/tool-help.js"></script>
<style>
	#tracks {
		font-family: verdana;
		list-style-type: none;
		margin: 0px;
		padding: 0px;
		width: 300px;
	}
	#tracks li {
		cursor: move;
		position: relative;
		float: left;
		margin: 3px 2px 0px 0px;
		width: 430px;
    font-size: 11px;
		border: 1px solid #000;
		text-align: left;
		padding: 2px 0px 2px 24px;
		background-color: #eeeeff;
	}
  #tracks li span { display: none; }
</style>
<h2>${args/playlist/cart_name} <span style="font-weight: normal;font-size:11px;color:green;">(drag and drop names to order the list)</span></h2>
<div id="savedorder" style="display:none"> </div>
<ul id="tracks" class="box">
  <li tal:repeat="R args/records"><i>${R/upload_name}</i> by ${R/user_real_name}<span>${R/cart_item_id}</span></li>
</ul>

<form style="clear:left; margin: 10px 0px 0px 60px" method="post" action="${args/postbackurl}" onsubmit="dopost()">
  <input type="hidden" id="idorder" name="idorder" value="" />
  <tal:block define="submit_text php:_('Submit Track Order');" />
<br /><br /><br />
  <input type="submit" value="${submit_text}" />
</form>

<script>
<!--
var dragsort = ToolMan.dragsort();
var junkdrawer = ToolMan.junkdrawer();

dragsort.makeListSortable(document.getElementById("tracks"), verticalOnly, saveOrder);

function verticalOnly(item) {
  item.toolManDragGroup.verticalOnly();
}

function saveOrder(item) {
  var group = item.toolManDragGroup;
  var list = group.element.parentNode;
  var id = list.getAttribute("id");
  if (id == null) return;
  group.register('dragend', function() {
    var so =document.getElementById("savedorder");
    so.innerHTML = junkdrawer.serializeList(list); // .match(/((?:span>)[0-9]+)/);
  });
}

//-->
</script>

</metal:block>

</tal:block>